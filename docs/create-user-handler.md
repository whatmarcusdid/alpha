# Create User Handler Documentation

## Overview

The `create_user` action creates a new TSG customer account in Firestore with all required fields, proper defaults, and tier-based hour allocation.

**Action:** `create_user`
**Special Note:** This is the only action that does NOT require a `userId` in the request (since we're creating the user).

---

## API Request

### Endpoint
```
POST /api/delivery-scout
```

### Request Format

```json
{
  "action": "create_user",
  "data": {
    "email": "john@blueridgeplumbing.com",
    "displayName": "John Smith",
    "tier": "advanced",
    "companyName": "Blue Ridge Plumbing",
    "websiteUrl": "https://blueridgeplumbing.com",
    "businessService": "Plumbing",
    "serviceArea": "Baltimore, MD"
  }
}
```

**Note:** Unlike other actions, `userId` is **not required** in the request body.

---

## Required Fields

| Field | Type | Validation |
|-------|------|------------|
| `email` | string | Valid email format |
| `displayName` | string | Non-empty string |
| `tier` | enum | Must be `essential`, `advanced`, or `premium` |

---

## Optional Fields (Company Info)

| Field | Type | Validation |
|-------|------|------------|
| `companyName` | string | Non-empty if provided |
| `websiteUrl` | string | Valid URL format if provided |
| `businessService` | string | Non-empty if provided |
| `serviceArea` | string | Non-empty if provided |
| `yearFounded` | number | Integer, 1800 to current year |
| `numEmployees` | number | Positive integer |
| `address` | string | Non-empty if provided |
| `city` | string | Non-empty if provided |
| `state` | string | Non-empty if provided |
| `zipCode` | string | Non-empty if provided |

---

## Response

### Success (200)
```json
{
  "success": true,
  "message": "User created successfully",
  "userId": "8xK3pQm9vLn2"
}
```

**Important:** The `userId` is auto-generated by Firestore. Save this ID for future operations.

### Validation Error (200)
```json
{
  "success": false,
  "error": "Validation failed",
  "validationErrors": [
    "email: Must be a valid email address"
  ]
}
```

---

## Tier-Based Hour Allocation

The handler automatically sets support and maintenance hours based on the subscription tier:

| Tier | Support Hours | Maintenance Hours | Monthly Cost |
|------|--------------|-------------------|--------------|
| **Essential** | 3 hrs/month | 6 hrs/month | $99/mo |
| **Advanced** | 8 hrs/month | 12 hrs/month | $249/mo |
| **Premium** | 15 hrs/month | 20 hrs/month | $499/mo |

---

## Firestore Document Created

```javascript
users/{auto-generated-id}
{
  // User identity
  email: "john@blueridgeplumbing.com",
  displayName: "John Smith",
  createdAt: <server-timestamp>,
  
  // Subscription details
  subscription: {
    tier: "advanced",
    status: "active",
    startDate: <server-timestamp>,
    endDate: null,
    lastUpdated: <server-timestamp>
  },
  
  // Initialize metrics with defaults
  metrics: {
    websiteTraffic: 0,
    siteSpeedSeconds: 0,
    supportHoursRemaining: 8,        // Based on tier
    maintenanceHoursRemaining: 12,   // Based on tier
    lastUpdated: <server-timestamp>
  },
  
  // Company information (from request)
  company: {
    legalName: "Blue Ridge Plumbing",
    websiteUrl: "https://blueridgeplumbing.com",
    businessService: "Plumbing",
    serviceArea: "Baltimore, MD",
    yearFounded: null,
    numEmployees: null,
    address: "",
    city: "",
    state: "",
    zipCode: "",
    lastUpdated: <server-timestamp>
  },
  
  // Meeting (empty initially)
  meeting: null
}
```

---

## Default Values

The handler sets these defaults automatically:

| Field | Default Value |
|-------|--------------|
| `subscription.status` | `"active"` |
| `subscription.startDate` | Server timestamp |
| `subscription.endDate` | `null` |
| `metrics.websiteTraffic` | `0` |
| `metrics.siteSpeedSeconds` | `0` |
| `metrics.supportHoursRemaining` | Based on tier (3/8/15) |
| `metrics.maintenanceHoursRemaining` | Based on tier (6/12/20) |
| `meeting` | `null` |
| Company fields (if not provided) | Empty string or `null` |

---

## Examples

### Minimal Request (Essential Tier)

```bash
curl -X POST https://my.tradesitegenie.com/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "jane@example.com",
      "displayName": "Jane Doe",
      "tier": "essential"
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "User created successfully",
  "userId": "9aB2cD3eF4gH"
}
```

**Firestore Result:**
- Support hours: 3
- Maintenance hours: 6
- Company fields: All empty/null

---

### Complete Request (Premium Tier)

```bash
curl -X POST https://my.tradesitegenie.com/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "owner@acmehvac.com",
      "displayName": "Michael Johnson",
      "tier": "premium",
      "companyName": "Acme HVAC Services",
      "websiteUrl": "https://acmehvac.com",
      "businessService": "HVAC",
      "serviceArea": "Greater Phoenix Area",
      "yearFounded": 2010,
      "numEmployees": 25,
      "address": "123 Main St",
      "city": "Phoenix",
      "state": "AZ",
      "zipCode": "85001"
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "User created successfully",
  "userId": "5xY6zW7vU8tS"
}
```

**Firestore Result:**
- Support hours: 15
- Maintenance hours: 20
- Company fields: All populated

---

## Validation Examples

### ‚ùå Missing Required Field (email)

```bash
curl -X POST http://localhost:3000/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "displayName": "John Smith",
      "tier": "advanced"
    }
  }'
```

**Response:**
```json
{
  "success": false,
  "error": "Validation failed",
  "validationErrors": [
    "email: Required"
  ]
}
```

---

### ‚ùå Invalid Email Format

```bash
curl -X POST http://localhost:3000/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "not-an-email",
      "displayName": "John Smith",
      "tier": "advanced"
    }
  }'
```

**Response:**
```json
{
  "success": false,
  "error": "Validation failed",
  "validationErrors": [
    "email: Must be a valid email address"
  ]
}
```

---

### ‚ùå Invalid Tier

```bash
curl -X POST http://localhost:3000/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "john@example.com",
      "displayName": "John Smith",
      "tier": "pro"
    }
  }'
```

**Response:**
```json
{
  "success": false,
  "error": "Validation failed",
  "validationErrors": [
    "tier: Must be one of: essential, advanced, premium"
  ]
}
```

---

### ‚ùå Invalid URL

```bash
curl -X POST http://localhost:3000/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "john@example.com",
      "displayName": "John Smith",
      "tier": "advanced",
      "websiteUrl": "not-a-url"
    }
  }'
```

**Response:**
```json
{
  "success": false,
  "error": "Validation failed",
  "validationErrors": [
    "websiteUrl: Website URL must be valid (e.g., https://example.com)"
  ]
}
```

---

### ‚ùå Invalid Year Founded

```bash
curl -X POST http://localhost:3000/api/delivery-scout \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "john@example.com",
      "displayName": "John Smith",
      "tier": "advanced",
      "yearFounded": 1500
    }
  }'
```

**Response:**
```json
{
  "success": false,
  "error": "Validation failed",
  "validationErrors": [
    "yearFounded: Number must be greater than or equal to 1800"
  ]
}
```

---

## Use Cases

### 1. Lindy AI Creates Customer After Purchase

When a customer completes signup/payment:

```javascript
{
  "action": "create_user",
  "data": {
    "email": "customer@business.com",
    "displayName": "Customer Name",
    "tier": "advanced",
    "companyName": "Their Business Name",
    // ... other company fields from form
  }
}
```

### 2. Bulk Import Existing Customers

```javascript
// Loop through customer list
customers.forEach(customer => {
  fetch('/api/delivery-scout', {
    method: 'POST',
    body: JSON.stringify({
      action: 'create_user',
      data: {
        email: customer.email,
        displayName: customer.name,
        tier: customer.subscriptionTier,
        // ... company fields
      }
    })
  });
});
```

### 3. Manual Account Creation

TSG admin creates account for new customer:

```javascript
{
  "action": "create_user",
  "data": {
    "email": "newclient@example.com",
    "displayName": "New Client",
    "tier": "essential",
    // Minimal info to start
  }
}
```

---

## Important Notes

### üîë Special Handling

1. **No userId in request** - Unlike all other actions, `create_user` does not require (or accept) a `userId` field in the request body.

2. **Auto-generated ID** - Firestore automatically generates a unique ID for the new user document.

3. **ID returned in response** - The auto-generated `userId` is returned in the response so you know what ID was created.

### ‚ö†Ô∏è Not Idempotent

Calling `create_user` multiple times with the same data will create **multiple user documents**. 

To prevent duplicates:
- Check if email already exists before calling create_user
- Or implement deduplication logic in your workflow

### üîí Security Note

This action creates new users in your production database. Ensure:
- API key is properly secured
- Rate limiting is active (100 requests/hour)
- You monitor for unusual creation patterns

---

## Testing

### Test Locally

```bash
curl -X POST http://localhost:3000/api/delivery-scout \
  -H "Authorization: Bearer $(grep DELIVERY_SCOUT_API_KEY .env.local | cut -d'=' -f2)" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create_user",
    "data": {
      "email": "test@example.com",
      "displayName": "Test User",
      "tier": "advanced",
      "companyName": "Test Company"
    }
  }' \
  -i
```

**Expected:** 200 OK with `userId` in response

### Verify in Firestore

1. Go to Firebase Console ‚Üí Firestore
2. Navigate to `users` collection
3. Find the document with the returned `userId`
4. Verify all fields are present:
   - ‚úÖ email, displayName, createdAt
   - ‚úÖ subscription (tier, status, startDate)
   - ‚úÖ metrics (with tier-based hours)
   - ‚úÖ company (with provided fields)

---

## Code Implementation

### Type Definition

```typescript
export const CreateUserSchema = z.object({
  email: z.string().email('Must be a valid email address'),
  displayName: NonEmptyString,
  tier: SubscriptionTierSchema,
  // Optional company fields
  companyName: OptionalNonEmptyString,
  websiteUrl: z.string().url('Website URL must be valid').optional(),
  businessService: OptionalNonEmptyString,
  serviceArea: OptionalNonEmptyString,
  yearFounded: z.number().int().min(1800).max(new Date().getFullYear()).optional(),
  numEmployees: z.number().int().positive('Number of employees must be positive').optional(),
  address: OptionalNonEmptyString,
  city: OptionalNonEmptyString,
  state: OptionalNonEmptyString,
  zipCode: OptionalNonEmptyString,
});

export type CreateUserPayload = z.infer<typeof CreateUserSchema>;
```

### Handler Function

```typescript
async function handleCreateUser(
  data: unknown
): Promise<DeliveryScoutResponse> {
  // Validate payload
  const validation = validatePayload(ValidationSchemas.create_user, data);
  if (!validation.success) {
    return {
      success: false,
      error: 'Validation failed',
      validationErrors: validation.errors,
    };
  }

  // Determine hours based on tier
  const tierHours = {
    essential: { support: 3, maintenance: 6 },
    advanced: { support: 8, maintenance: 12 },
    premium: { support: 15, maintenance: 20 },
  };

  const hours = tierHours[tier];

  // Create user document
  const userData = {
    email,
    displayName,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    subscription: {
      tier,
      status: 'active',
      startDate: admin.firestore.FieldValue.serverTimestamp(),
      endDate: null,
      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
    },
    metrics: {
      websiteTraffic: 0,
      siteSpeedSeconds: 0,
      supportHoursRemaining: hours.support,
      maintenanceHoursRemaining: hours.maintenance,
      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
    },
    company: {
      legalName: companyName || '',
      websiteUrl: websiteUrl || '',
      // ... other fields
      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
    },
    meeting: null,
  };

  // Add to users collection
  const newUserRef = await adminDb.collection('users').add(userData);

  return {
    success: true,
    message: 'User created successfully',
    userId: newUserRef.id,
  };
}
```

### Switch Statement

```typescript
switch (action) {
  case 'create_user':
    // Special case: no userId needed
    response = await handleCreateUser(data);
    break;
    
  case 'update_meeting':
    response = await handleUpdateMeeting(userId, data);
    break;
    
  // ... other cases
}
```

---

## Summary

| Feature | Implementation |
|---------|---------------|
| **Required Fields** | email, displayName, tier |
| **Auto-Generated** | userId (returned in response) |
| **Tier Hours** | Essential=3, Advanced=8, Premium=15 |
| **Timestamps** | All use serverTimestamp() |
| **Validation** | Zod schema with email, URL, tier checks |
| **Idempotent** | No - creates new user each time |
| **Special Note** | Only action that doesn't require userId in request |

---

## Next Steps

1. **Test the endpoint** with curl command
2. **Verify in Firestore** that user was created with all fields
3. **Update Lindy AI workflow** to use create_user action
4. **Add deduplication logic** if needed (check email before creating)
5. **Update test suite** to include create_user tests

The `create_user` handler is now fully implemented and ready to use! üéâ
